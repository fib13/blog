<!doctype html><html><head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<link rel=canonical href=https://www.shisanshiji.com/troubleshooting/elasticsearch-troubleshooting/>
<title>
Elasticsearch 问题排查 | 十三时记
</title>
<link href=https://www.shisanshiji.com/css/fontawesome.min.css rel=stylesheet>
<link rel=stylesheet href=https://www.shisanshiji.com/css/ace.min.css>
<link rel=icon href=https://www.shisanshiji.com/img/favicon.png type=image/x-icon>
</head>
<body><nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow sticky-top" id=navbarMain>
<div class=container>
<div>
<a class=navbar-brand href=/>
十三时记
</a>
</div>
<button class="navbar-toggler navbar-toggler-right collapsed" type=button data-toggle=collapse data-target=#navbarMainCollapse aria-controls=navbarMainCollapse aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span>
</button>
<div class="collapse navbar-collapse" id=navbarMainCollapse>
<ul class="navbar-nav ml-auto">
<li class=nav-item>
<a class=nav-link href=https://github.com/jugggao target=_blank>
<i class="fab fa-github"></i>
</a>
</li>
</ul>
</div>
</div>
</nav>
<div class=container-fluid>
<div class=row>
<div class="docs-sidenav order-0 col-12 col-md-3 col-lg-2 col-xl-2 position-sticky border-right"><nav class="navbar navbar-expand-md navbar-light pl-0">
<button class="navbar-toggler navbar-toggler-right collapsed" type=button data-toggle=collapse data-target=#sidenav-left-collapse aria-controls=sidenav-left-collapse aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span>
</button>
<div class="collapse navbar-collapse align-items-start flex-column" id=sidenav-left-collapse>
<form class="form-inline my-2 my-lg-0 searchbox">
<input class="form-control mr-sm-2 w-100" data-search-input id=search-by type=text placeholder=Search>
</form>
<ul class="navbar-nav flex-column pt-3">
<li data-nav-id=/learn-notes/ class="nav-item my-1 haschildren">
<a class="nav-link p-0" href=/learn-notes/><h6>学习笔记</h6></a>
<ul class="list-unstyled ml-2">
<li data-nav-id=/learn-notes/tekton/ class="nav-item my-1 haschildren">
<a class="nav-link p-0" href=/learn-notes/tekton/><h6>Tekton 学习与实践</h6></a>
<ul class="list-unstyled ml-2">
<li data-nav-id=/learn-notes/tekton/tekton-task-parctice/ class="nav-item my-1">
<a href=/learn-notes/tekton/tekton-task-parctice/ class="nav-link p-0">
Tekton Task 实践
</a>
</li>
<li data-nav-id=/learn-notes/tekton/tekton-pipeline-practice/ class="nav-item my-1">
<a href=/learn-notes/tekton/tekton-pipeline-practice/ class="nav-link p-0">
Tekton Pipeline 实践
</a>
</li>
</ul>
</li>
</ul>
</li>
<li data-nav-id=/operation-guide/ class="nav-item my-1 haschildren">
<a class="nav-link p-0" href=/operation-guide/><h6>操作指南</h6></a>
<ul class="list-unstyled ml-2">
<li data-nav-id=/operation-guide/hugo-githubactiongithub-pages-%E6%90%AD%E5%BB%BA%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2/ class="nav-item my-1">
<a href=/operation-guide/hugo-githubactiongithub-pages-%E6%90%AD%E5%BB%BA%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2/ class="nav-link p-0">
Hugo&Github Action&Github Pages 搭建个人博客
</a>
</li>
</ul>
</li>
<li data-nav-id=/troubleshooting/ class="nav-item my-1 parent haschildren">
<a class="nav-link p-0" href=/troubleshooting/><h6>问题排查</h6></a>
<ul class="list-unstyled ml-2">
<li data-nav-id=/troubleshooting/elasticsearch-troubleshooting/ class="nav-item my-1 active">
<a href=/troubleshooting/elasticsearch-troubleshooting/ class="nav-link p-0">
Elasticsearch 问题排查
</a>
</li>
</ul>
</li>
</ul>
</div>
</nav>
</div>
<div class="docs-toc large order-lg-2 order-md-0 order-xs-1 col-12 col-lg-2 col-xl-2 position-sticky border-left"><div class=docs-toc>
<nav id=TableOfContents>
<ul>
<li><a href=#集群中包含未分配的副本导致集群变为-red-状态>集群中包含未分配的副本导致集群变为 Red 状态</a>
<ul>
<li><a href=#查看集群状态信息>查看集群状态信息</a></li>
<li><a href=#解决方法>解决方法</a></li>
</ul>
</li>
</ul>
</nav>
</div>
</div>
<div class="main col-12 order-1 col-md-9 col-lg-10 col-xl-8 py-3">
<h1>Elasticsearch 问题排查</h1>
<p>问题列表如下：</p>
<ul>
<li><a href=#%E9%9B%86%E7%BE%A4%E4%B8%AD%E5%8C%85%E5%90%AB%E6%9C%AA%E5%88%86%E9%85%8D%E7%9A%84%E5%89%AF%E6%9C%AC%E5%AF%BC%E8%87%B4%E9%9B%86%E7%BE%A4%E5%8F%98%E4%B8%BA-red-%E7%8A%B6%E6%80%81>集群中包含未分配的副本导致集群变为 Red 状态</a></li>
</ul>
<h2 id=集群中包含未分配的副本导致集群变为-red-状态>集群中包含未分配的副本导致集群变为 Red 状态</h2>
<h3 id=查看集群状态信息>查看集群状态信息</h3>
<p>首先确定原因。</p>
<h4 id=查看整体健康信息>查看整体健康信息</h4>
<div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ curl -u <span style=color:#d88200>&#39;elastic:password&#39;</span> <span style=color:#d88200>&#39;http://127.0.0.1:9200/_cluster/health?pretty&#39;</span>
<span style=color:#f92672>{</span>
  <span style=color:#d88200>&#34;cluster_name&#34;</span> : <span style=color:#d88200>&#34;elasticsearch&#34;</span>,
  <span style=color:#d88200>&#34;status&#34;</span> : <span style=color:#d88200>&#34;red&#34;</span>,
  <span style=color:#d88200>&#34;timed_out&#34;</span> : false,
  <span style=color:#d88200>&#34;number_of_nodes&#34;</span> : 1,
  <span style=color:#d88200>&#34;number_of_data_nodes&#34;</span> : 1,
  <span style=color:#d88200>&#34;active_primary_shards&#34;</span> : 69,
  <span style=color:#d88200>&#34;active_shards&#34;</span> : 69,
  <span style=color:#d88200>&#34;relocating_shards&#34;</span> : 0,
  <span style=color:#d88200>&#34;initializing_shards&#34;</span> : 0,
  <span style=color:#d88200>&#34;unassigned_shards&#34;</span> : 1,
  <span style=color:#d88200>&#34;delayed_unassigned_shards&#34;</span> : 0,
  <span style=color:#d88200>&#34;number_of_pending_tasks&#34;</span> : 0,
  <span style=color:#d88200>&#34;number_of_in_flight_fetch&#34;</span> : 0,
  <span style=color:#d88200>&#34;task_max_waiting_in_queue_millis&#34;</span> : 0,
  <span style=color:#d88200>&#34;active_shards_percent_as_number&#34;</span> : 98.57142857142858
<span style=color:#f92672>}</span>
</code></pre></div><p><strong>主要关注其中的 <code>unassigned_shards</code> 指标</strong>，其代表已经在集群状态中存在的分片，但是实际在集群里又找不着。通常未分配分片的来源是未分配的副本。比如，一个有 5 分片和 1 副本的索引，在单节点集群上，就会有 5 个未分配副本分片。如果你的集群是 red 状态，也会长期保有未分配分片（因为缺少主分片）。其他指标解释：</p>
<ul>
<li>
<p><code>initializing_shards</code> 是刚刚创建的分片的个数。比如，当你刚创建第一个索引，分片都会短暂的处于 initializing 状态。这通常会是一个临时事件，分片不应该长期停留在 initializing 状态。你还可能在节点刚重启的时候看到 initializing 分片：当分片从磁盘上加载后，它们会从 initializing 状态开始。</p>
</li>
<li>
<p><code>number_of_nodes</code> 和 <code>number_of_data_nodes</code>：可由字面意思理解。</p>
</li>
<li>
<p><code>active_primary_shards</code>：指出你集群中的主分片数量。这是涵盖了所有索引的汇总值。</p>
</li>
<li>
<p><code>active_shards</code>：所有索引的所有分片的汇总值，即包括副本分片。</p>
</li>
<li>
<p><code>relocating_shards</code>：显示当前正在从一个节点迁往其他节点的分片的数量。通常来说应该是 0，不过在 Elasticsearch 发现集群不太均衡时，该值会上涨。比如说：添加了一个新节点，或者下线了一个节点。</p>
</li>
<li>
<p><code>active_shards_percent_as_number</code>：活跃分片数占总分片数比例。</p>
</li>
</ul>
<h4 id=查看每个索引的健康信息>查看每个索引的健康信息</h4>
<p>我们还可以通过 <code>level</code> 参数查看更详细的信息：</p>
<div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>curl -u elastic:password <span style=color:#d88200>&#39;http://127.0.0.1:9200/_cluster/health?pretty=true&amp;level=indices&#39;</span>
<span style=color:#f92672>{</span>
  <span style=color:#d88200>&#34;cluster_name&#34;</span> : <span style=color:#d88200>&#34;elasticsearch&#34;</span>,
  <span style=color:#d88200>&#34;status&#34;</span> : <span style=color:#d88200>&#34;red&#34;</span>,
  <span style=color:#d88200>&#34;timed_out&#34;</span> : false,
  <span style=color:#d88200>&#34;number_of_nodes&#34;</span> : 1,
  <span style=color:#d88200>&#34;number_of_data_nodes&#34;</span> : 1,
  <span style=color:#d88200>&#34;active_primary_shards&#34;</span> : 69,
  <span style=color:#d88200>&#34;active_shards&#34;</span> : 69,
  <span style=color:#d88200>&#34;relocating_shards&#34;</span> : 0,
  <span style=color:#d88200>&#34;initializing_shards&#34;</span> : 0,
  <span style=color:#d88200>&#34;unassigned_shards&#34;</span> : 2,
  <span style=color:#d88200>&#34;delayed_unassigned_shards&#34;</span> : 0,
  <span style=color:#d88200>&#34;number_of_pending_tasks&#34;</span> : 0,
  <span style=color:#d88200>&#34;number_of_in_flight_fetch&#34;</span> : 0,
  <span style=color:#d88200>&#34;task_max_waiting_in_queue_millis&#34;</span> : 0,
  <span style=color:#d88200>&#34;active_shards_percent_as_number&#34;</span> : 97.1830985915493,
  <span style=color:#d88200>&#34;indices&#34;</span> : <span style=color:#f92672>{</span>
...
    <span style=color:#d88200>&#34;kubernetes-2021.08.13&#34;</span> : <span style=color:#f92672>{</span>
      <span style=color:#d88200>&#34;status&#34;</span> : <span style=color:#d88200>&#34;green&#34;</span>,
      <span style=color:#d88200>&#34;number_of_shards&#34;</span> : 1,
      <span style=color:#d88200>&#34;number_of_replicas&#34;</span> : 0,
      <span style=color:#d88200>&#34;active_primary_shards&#34;</span> : 1,
      <span style=color:#d88200>&#34;active_shards&#34;</span> : 1,
      <span style=color:#d88200>&#34;relocating_shards&#34;</span> : 0,
      <span style=color:#d88200>&#34;initializing_shards&#34;</span> : 0,
      <span style=color:#d88200>&#34;unassigned_shards&#34;</span> : <span style=color:#ae81ff>1</span>
    <span style=color:#f92672>}</span>,
...
  <span style=color:#f92672>}</span>
</code></pre></div><p>添加 <code>level=indices</code> 参数会在集群健康信息里添加一个索引清单，以及有关每个索引的细节（状态、分片数、未分配分片数等等），一旦我们询问要索引的输出，哪个索引有问题立马就很清楚了：<code>kubernetes-2021.08.13</code>。</p>
<h4 id=查看每个索引的每个分片的健康信息>查看每个索引的每个分片的健康信息</h4>
<p>我们可以更细致的输出索引的每个分片的健康信息，通过添加参数 <code>level=shards</code> 获取。</p>
<div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>curl -u <span style=color:#d88200>&#39;elastic:password&#39;</span> <span style=color:#d88200>&#39;http://127.0.0.1:9200/_cluster/health?pretty=true&amp;level=shards&#39;</span>
</code></pre></div><p>通过添加 <code>level=indices</code> 参数可以列出每个索引里每个分片的状态和位置。这个输出有时候很有用，但是由于太过详细会比较难用。</p>
<h4 id=查看未分配分片的索引及原因>查看未分配分片的索引及原因</h4>
<div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>curl -u <span style=color:#d88200>&#39;elastic:password&#39;</span> <span style=color:#d88200>&#39;http://127.0.0.1:9200/_cat/shards?v&amp;h=index,shard,prirep,state,unassigned.reason&#39;</span>
index                    shard prirep state      unassigned.reason
.apm-custom-link         <span style=color:#ae81ff>0</span>     p      STARTED    
... 
kubernetes-2021.10.10    <span style=color:#ae81ff>0</span>     p      STARTED    
kubernetes-2021.11.03    <span style=color:#ae81ff>0</span>     p      UNASSIGNED CLUSTER_RECOVERED
kubernetes-2021.08.19    <span style=color:#ae81ff>0</span>     p      STARTED    
...
</code></pre></div><p><code>unassigned.reason</code> 值说明：</p>
<ul>
<li><code>INDEX_CREATED</code>: 由于创建索引的 API 导致未分配。</li>
<li><code>CLUSTER_RECOVERED</code>: 由于完全集群恢复导致未分配。</li>
<li><code>INDEX_REOPENED</code>: 由于打开 open 或关闭 close 一个索引导致未分配。</li>
<li><code>DANGLING_INDEX_IMPORTED</code>: 由于导入 dangling 索引的结果导致未分配。</li>
<li><code>NEW_INDEX_RESTORED</code>: 由于恢复到新索引导致未分配。</li>
<li><code>EXISTING_INDEX_RESTORED</code>: 由于恢复到已关闭的索引导致未分配。</li>
<li><code>REPLICA_ADDED</code>: 由于显式添加副本分片导致未分配。</li>
<li><code>ALLOCATION_FAILED</code>: 由于分片分配失败导致未分配。</li>
<li><code>NODE_LEFT</code>: 由于承载该分片的节点离开集群导致未分配。</li>
<li><code>REINITIALIZED</code>: 由于当分片从开始移动到初始化时导致未分配（例如，使用Shadow 副本分片）。</li>
<li><code>REROUTE_CANCELLED</code>: 作为显式取消重新路由命令的结果取消分配。</li>
<li><code>REALLOCATED_REPLICA</code>: 确定更好的副本位置被标定使用，导致现有的副本分配被取消，出现未分配。</li>
</ul>
<h3 id=解决方法>解决方法</h3>
<p>由两种方法可解决，任选其中一种即可。</p>
<h4 id=手动分配>手动分配</h4>
<div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>curl -u <span style=color:#d88200>&#39;elastic:password&#39;</span> -H <span style=color:#d88200>&#34;Content-Type: application/json&#34;</span> <span style=color:#d88200>&#39;http://127.0.0.1:9200/_cluster/reroute&#39;</span> -d <span style=color:#d88200>&#39;{
</span><span style=color:#d88200>    &#34;commands&#34;: [{
</span><span style=color:#d88200>        &#34;allocate&#34;: {
</span><span style=color:#d88200>            &#34;index&#34;: &#34;&lt;索引名称&gt;&#34;,
</span><span style=color:#d88200>            &#34;shard&#34;: &lt;分片编号&gt;,
</span><span style=color:#d88200>            &#34;node&#34;: &#34;&lt;节点 ID&gt;&#34;,
</span><span style=color:#d88200>            &#34;allow_primary&#34;: true
</span><span style=color:#d88200>        }
</span><span style=color:#d88200>    }]
</span><span style=color:#d88200>}&#39;</span>
</code></pre></div><p>批处理脚本：</p>
<div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e>#!/bin/bash
</span><span style=color:#75715e></span><span style=color:#111>array</span><span style=color:#f92672>=(</span> node1 node2 node3 <span style=color:#f92672>)</span>
<span style=color:#111>node_counter</span><span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>
<span style=color:#111>length</span><span style=color:#f92672>=</span><span style=color:#d88200>${#</span><span style=color:#111>array</span><span style=color:#111>[@]</span><span style=color:#d88200>}</span>
<span style=color:#111>IFS</span><span style=color:#f92672>=</span><span style=color:#d88200>$&#39;\n&#39;</span>
<span style=color:#00a8c8>for</span> line in <span style=color:#00a8c8>$(</span>curl -s <span style=color:#d88200>&#39;http://127.0.0.1:9200/_cat/shards&#39;</span><span style=color:#111>|</span>  fgrep UNASSIGNED<span style=color:#00a8c8>)</span><span style=color:#111>;</span> <span style=color:#00a8c8>do</span>
    <span style=color:#111>INDEX</span><span style=color:#f92672>=</span><span style=color:#00a8c8>$(</span><span style=color:#111>echo</span> <span style=color:#111>$line</span> <span style=color:#111>|</span> <span style=color:#f92672>(</span>awk <span style=color:#d88200>&#39;{print $1}&#39;</span><span style=color:#00a8c8>)</span><span style=color:#f92672>)</span>
    <span style=color:#111>SHARD</span><span style=color:#f92672>=</span><span style=color:#00a8c8>$(</span><span style=color:#111>echo</span> <span style=color:#111>$line</span> <span style=color:#111>|</span> <span style=color:#f92672>(</span>awk <span style=color:#d88200>&#39;{print $2}&#39;</span><span style=color:#00a8c8>)</span><span style=color:#f92672>)</span>
    <span style=color:#111>NODE</span><span style=color:#f92672>=</span><span style=color:#d88200>${</span><span style=color:#111>array</span><span style=color:#111>[</span><span style=color:#111>$node_counter</span><span style=color:#111>]</span><span style=color:#d88200>}</span>
    <span style=color:#111>echo</span> <span style=color:#111>$NODE</span>
    curl -XPOST <span style=color:#d88200>&#39;http://127.0.0.1:9200/_cluster/reroute&#39;</span> -d <span style=color:#d88200>&#39;{
</span><span style=color:#d88200>        &#34;commands&#34;: [
</span><span style=color:#d88200>        {
</span><span style=color:#d88200>            &#34;allocate&#34;: {
</span><span style=color:#d88200>                &#34;index&#34;: &#34;&#39;</span><span style=color:#111>$INDEX</span><span style=color:#d88200>&#39;&#34;,
</span><span style=color:#d88200>                &#34;shard&#34;: &#39;</span><span style=color:#111>$SHARD</span><span style=color:#d88200>&#39;,
</span><span style=color:#d88200>                &#34;node&#34;: &#34;&#39;</span><span style=color:#111>$NODE</span><span style=color:#d88200>&#39;&#34;,
</span><span style=color:#d88200>                &#34;allow_primary&#34;: true
</span><span style=color:#d88200>            }
</span><span style=color:#d88200>        }
</span><span style=color:#d88200>        ]
</span><span style=color:#d88200>    }&#39;</span>
    <span style=color:#111>node_counter</span><span style=color:#f92672>=</span><span style=color:#00a8c8>$((</span><span style=color:#f92672>(</span>node_counter<span style=color:#f92672>)%</span>length <span style=color:#f92672>+</span><span style=color:#ae81ff>1</span><span style=color:#00a8c8>))</span>
<span style=color:#00a8c8>done</span>
</code></pre></div><h4 id=重新建立副本>重新建立副本</h4>
<p>如果在上面的命令执行输出结果中，假如所有的 <code>primary shards</code> 都是正常的，所有 <code>replica shards</code> 有问题，有一种快速恢复的方法，就是强制删除掉 <code>replica shards</code>，让 Elasticsearch 自主重新生成。</p>
<p>首先先将出问题的索引的副本为 0：</p>
<div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>curl -u <span style=color:#d88200>&#39;elastic:password&#39;</span> -H <span style=color:#d88200>&#34;Content-Type: application/json&#34;</span> -X PUT <span style=color:#d88200>&#39;http://127.0.0.1:9200/&lt;索引名称&gt;/_settings&#39;</span> -d <span style=color:#d88200>&#39;{ &#34;index&#34;: {&#34;number_of_replicas&#34;: 0}}&#39;</span>
</code></pre></div><p>然后观察集群状态，最后通过命令在恢复期索引副本数据：</p>
<div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>curl -u <span style=color:#d88200>&#39;elastic:password&#39;</span> -H <span style=color:#d88200>&#34;Content-Type: application/json&#34;</span> -X PUT <span style=color:#d88200>&#39;http://127.0.0.1:9200/&lt;索引名称&gt;/_settings&#39;</span> -d <span style=color:#d88200>&#39;{ &#34;index&#34;: {&#34;number_of_replicas&#34;: 1}}&#39;</span>
</code></pre></div><p>等待节点自动分配后，集群成功恢复成 green。</p>
<div class=row><div class="position-relative mx-auto col-lg-9">
<div class="bg-primary overflow-hidden p-3 mt-5 shadow">
<h4 class="text-white text-center">阅读更多</h4>
<div class="d-flex justify-content-center"><a class="p-1 mr-3 d-inline-block text-white" href=/troubleshooting/ title=问题排查><i class="fas fa-chevron-left p-1"></i>问题排查</a>
<a class="p-1 ml-3 d-inline-block text-white text-right" href=/learn-notes/ title=学习笔记>学习笔记<i class="fas fa-chevron-right p-1"></i></a>
</div>
</div>
</div></div>
</div>
</div>
</div>
<script src=https://www.shisanshiji.com/lib/jquery.min.js></script>
<script src=https://www.shisanshiji.com/lib/popper.min.js></script>
<script src=https://www.shisanshiji.com/js/bootstrap.min.js></script>
<script type=text/javascript src=/plugins/lunr.min.js></script>
<script type=text/javascript src=/plugins/auto-complete.js></script>
<link href=/plugins/auto-complete.css rel=stylesheet>
<script type=text/javascript>var baseurl="https://www.shisanshiji.com/"</script>
<script type=text/javascript src=/plugins/search.js></script>
<script type=text/javascript src=/plugins/clipboard.js></script>
<script>new ClipboardJS('.btn')</script>
</body>
</html>